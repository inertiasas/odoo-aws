# Instalación {#install}

https://www.vultr.com/docs/installing-odoo-10-community-on-ubuntu-16-04

https://www.rosehosting.com/blog/how-to-install-odoo-10-on-ubuntu-16-04-with-nginx-as-a-reverse-proxy/

## Ingresar, actualizar y cerrar

### Abrir la conexión con la instancia

```{r eval=FALSE}
ssh -i /path/my-key-pair.pem my-instance-user-name@my-instance-public-dns-name
```

### Actualizar el sistema

Antes de instalar cualquier paquete en su instancia de Ubuntu, inicie sesión con el usuario `sudo` y actualice.

```{r eval=FALSE}
sudo apt-get update
sudo apt-get upgrade
```

### Cerrar la conexión con la instancia

```{r eval=FALSE}
sudo reboot
```

Una vez que el sistema se haya reiniciado, inicie sesión nuevamente como usuario `sudo` y continúe con los siguientes pasos.

## Agregar el repositorio de paquetes de Odoo

Ejecute los siguientes comandos como root:

```{r eval=FALSE}
sudo su
```

```{r eval=FALSE}
wget -O - https://nightly.odoo.com/odoo.key | apt-key add -
echo "deb http://nightly.odoo.com/10.0/nightly/deb/ ./" >> /etc/apt/sources.list.d/odoo.list
apt-get update
```

## Instalación PostgreSQL 9.5 en Ubuntu 16.04

https://www.calhoun.io/how-to-install-postgresql-9-5-on-ubuntu-16-04/

```{r eval=FALSE}
sudo apt-get update
sudo apt-get install postgresql postgresql-contrib
```

```{r eval=FALSE}
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

```{r eval=FALSE}
sudo systemctl status odoo
```

Se crea un usuario PostgreSQL con los siguientes comandos:

```{r eval=FALSE}
sudo su - postgres
createuser odoo -U postgres -dRSP
```

Cuando se le solicite, establezca una contraseña segura para el usuario de la base de datos y guárdela en un lugar seguro.

```{r eval=FALSE}
exit
```

## Instalar Odoo

```{r eval=FALSE}
sudo apt-get install odoo
```

Inicie Odoo y configúrelo para que se inicie automáticamente cuando se inicie el sistema.

```{r eval=FALSE}
sudo systemctl start odoo
sudo systemctl enable odoo
```

## Instale Nginx para facilitar el acceso del usuario

https://www.youtube.com/watch?v=7bHSUCKt3SE

Puede redirigir el tráfico en el puerto HTTP predeterminado (80) y el puerto HTTPS predeterminado (443) a Odoo (que se ejecuta en el puerto 8069) para que los usuarios ya no tengan que agregar el número de puerto 8069 cada vez que acceden al sistema. 

```{r eval=FALSE}
sudo apt-get install nginx
```

Edite el archivo de configuración del sitio Nginx utilizando un editor de texto, como nano.

```{r eval=FALSE}
sudo su
```

```{r eval=FALSE}
nano /etc/nginx/sites-available/default
```

Encuentra las siguientes líneas.

```{r eval=FALSE}
        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }
```

Y cambialo por los siguiente:

```{r eval=FALSE}
        #location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                # try_files $uri $uri/ =404;
        #}

        # PORT 8069 to PORT 80

        location / {
             proxy_pass http://localhost:8069;
             proxy_http_version 1.1;
             proxy_set_header Upgrade $http_upgrade;
             proxy_set_header Connection 'upgrade';
             proxy_set_header Host $host;
             proxy_cache_bypass $http_upgrade;
         }
```

Reinicie Nginx y configúrelo para que se inicie automáticamente cuando se inicie el sistema.

```{r eval=FALSE}
systemctl restart nginx
systemctl start nginx
```

Ahora puede visitar el sistema Odoo desde el puerto 8069 y el puerto 80.

```{r eval=FALSE}
http://[your-vultr-instance-IP]:8069
http://[your-vultr-instance-IP]
```

## Certificado SSL con Let’s Encrypt

https://clouding.io/hc/es/articles/360010373220-Configurar-SSL-en-la-imagen-de-Odoo

https://www.youtube.com/watch?v=7bHSUCKt3SE

### Instalación de Let’s Encrypt

Agregamos el repositorio y los actualizamos:

```{r eval=FALSE}
sudo su
add-apt-repository ppa:certbot/certbot
apt-get update
```

Y luego lo instalamos:

```{r eval=FALSE}
apt install python-certbot-nginx
```

Ajustamos el archico Nginx

```{r eval=FALSE}
nano /etc/nginx/sites-available/default
```

en `server_name` se incluye el dominio

```{r eval=FALSE}
server_name inertiasas.com www.inertiasas.com;
```

Guardamos y reiniciamos el servicio Nginx:

```{r eval=FALSE}
systemctl restart nginx
```

Activamos el firewall ufw:

```{r eval=FALSE}
ufw allow 'Nginx Full'
ufw allow 'OpenSSH'
ufw enable
```

Verificamos el estado de ufw:

```{r eval=FALSE}
ufw status
```

Lo cual debe retornar

```{r eval=FALSE}
To                         Action      From
--                         ------      ----
Nginx Full                 ALLOW       Anywhere                  
OpenSSH                    ALLOW       Anywhere                  
Nginx Full (v6)            ALLOW       Anywhere (v6)             
OpenSSH (v6)               ALLOW       Anywhere (v6) 
```

Generamos el certificado:

```{r eval=FALSE}
certbot --nginx -d inertiasas.com -d www.inertiasas.com
```

Las respuestas son las siguientes

```{r eval=FALSE}
Plugins selected: Authenticator nginx, Installer nginx
Enter email address (used for urgent renewal and security notices) (Enter 'c' to
cancel): luisca1985@gmail.com
```

```{r eval=FALSE}
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please read the Terms of Service at
https://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf. You must
agree in order to register with the ACME server at
https://acme-v02.api.letsencrypt.org/directory
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(A)gree/(C)ancel: A
```

```{r eval=FALSE}
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing to share your email address with the Electronic Frontier
Foundation, a founding partner of the Let's Encrypt project and the non-profit
organization that develops Certbot? We'd like to send you email about our work
encrypting the web, EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: N
```

```{r eval=FALSE}
Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: No redirect - Make no further changes to the webserver configuration.
2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for
new sites, or if you're confident your site works on HTTPS. You can undo this
change by editing your web server's configuration.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate number [1-2] then [enter] (press 'c' to cancel): 2
```

El mensaje final es:

```{r eval=FALSE}
IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/inertiasas.com/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/inertiasas.com/privkey.pem
   Your cert will expire on 2020-11-05. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot again
   with the "certonly" option. To non-interactively renew *all* of
   your certificates, run "certbot renew"
 - Your account credentials have been saved in your Certbot
   configuration directory at /etc/letsencrypt. You should make a
   secure backup of this folder now. This configuration directory will
   also contain certificates and private keys obtained by Certbot so
   making regular backups of this folder is ideal.
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
```

## Resultado de la instalación

```{r my-fig3, fig.cap="Odoo Instalado"}
knitr::include_graphics("images/odoo_init.png")
```



You can label chapter and section titles using `{#install}` after them, e.g., we can reference Chapter \@ref(install). If you do not manually label them, there will be automatic labels anyway, e.g., Chapter \@ref(methods).

Figures and tables with captions will be placed in `figure` and `table` environments, respectively.

```{r nice-fig, fig.cap='Here is a nice figure!', out.width='80%', fig.asp=.75, fig.align='center'}
par(mar = c(4, 4, .1, .1))
plot(pressure, type = 'b', pch = 19)
```

Reference a figure by its code chunk label with the `fig:` prefix, e.g., see Figure \@ref(fig:nice-fig). Similarly, you can reference tables generated from `knitr::kable()`, e.g., see Table \@ref(tab:nice-tab).

```{r nice-tab, tidy=FALSE}
knitr::kable(
  head(iris, 20), caption = 'Here is a nice table!',
  booktabs = TRUE
)
```

You can write citations, too. For example, we are using the **bookdown** package [@R-bookdown] in this sample book, which was built on top of R Markdown and **knitr** [@xie2015].
